# Prometheus Alerting Rules
# Generated by k8s-observability-agent
# Platform: {{ plan.platform_summary | truncate(80) }}
#
# nodata_state calibration:
#   ok       → alert stays silent when the metric is absent (default for optional exporters)
#   alerting → alert fires when the metric disappears (critical infrastructure)
#   nodata   → alert enters a special no-data state for triage

groups:
  - name: k8s_observability_alerts
    rules:
{% for alert in plan.alerts %}
      - alert: {{ alert.alert_name }}
        expr: {{ alert.expr }}
        for: {{ alert.for_duration }}
        labels:
          severity: {{ alert.severity }}
{% if alert.resource %}
          resource: "{{ alert.resource }}"
{% endif %}
{% if alert.nodata_state and alert.nodata_state != 'ok' %}
          nodata_state: "{{ alert.nodata_state }}"
{% endif %}
        annotations:
          summary: "{{ alert.summary | default(alert.alert_name) }}"
{% if alert.description %}
          description: "{{ alert.description }}"
{% endif %}
{% if alert.nodata_state == 'alerting' %}
          nodata_action: "This alert is configured to fire when data is absent — missing metrics likely indicate a down exporter or target."
{% endif %}
{% endfor %}

{% set alerting_nodata = plan.alerts | selectattr('nodata_state', 'equalto', 'alerting') | list %}
{% if alerting_nodata %}
  - name: k8s_observability_absent_metrics
    rules:
{% for alert in alerting_nodata %}
      - alert: {{ alert.alert_name }}Absent
        expr: absent({{ alert.expr.split(' ')[0].split('{')[0].split('>')[0].split('<')[0].strip() }})
        for: 10m
        labels:
          severity: warning
{% if alert.resource %}
          resource: "{{ alert.resource }}"
{% endif %}
        annotations:
          summary: "Metric for {{ alert.alert_name }} is absent — exporter may be down or not deployed"
          description: "The metric backing {{ alert.alert_name }} has not been seen for 10 minutes. Verify the exporter/target is running and being scraped."
{% endfor %}
{% endif %}
